{"version":3,"sources":["../scripts/feed.js"],"names":["window","friendlyPix","Feed","constructor","posts","newPosts","auth","firebase","$","document","ready","pageFeed","feedImageContainer","noPostsMessage","nextPageButton","newPostsButton","click","showNewPosts","addPosts","postIds","Object","keys","i","length","hide","postData","post","Post","push","postElement","fillPostData","thumb_url","url","text","author","timestamp","full_url","existingPostElement","replaceWith","append","addClass","toggleNextPageButton","nextPage","unbind","loadMorePosts","prop","console","log","then","data","entries","show","MaterialUtils","onEndScroll","postKeys","prepend","showGeneralFeed","clear","getPosts","latestPostId","subscribeToGeneralFeed","postId","postValue","addNewPost","registerForPostsDeletion","onPostDeleted","showHomeFeed","currentUser","updateHomeFeeds","getHomeFeedPosts","fadeIn","subscribeToHomeFeed","startHomeFeedLiveUpdaters","nbNewPosts","remove","stopOnEndScrolls","cancelAllSubscriptions","forEach","feed"],"mappings":"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","file":"feed.js","sourcesContent":["/**\n * Copyright 2015 Google Inc. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nwindow.friendlyPix = window.friendlyPix || {};\n\n/**\n * Handles the Home and Feed UI.\n */\nfriendlyPix.Feed = class {\n\n  /**\n   * Initializes the Friendly Pix feeds.\n   * @constructor\n   */\n  constructor() {\n    // List of all posts on the page.\n    this.posts = [];\n    // Map of posts that can be displayed.\n    this.newPosts = {};\n\n    // Firebase SDK.\n    this.auth = firebase.auth();\n\n    $(document).ready(() => {\n      // Pointers to DOM elements.\n      this.pageFeed = $('#page-feed');\n      this.feedImageContainer = $('.fp-image-container', this.pageFeed);\n      this.noPostsMessage = $('.fp-no-posts', this.pageFeed);\n      this.nextPageButton = $('.fp-next-page-button button');\n      this.newPostsButton = $('.fp-new-posts-button button');\n\n      // Event bindings.\n      this.newPostsButton.click(() => this.showNewPosts());\n    });\n  }\n\n  /**\n   * Appends the given list of `posts`.\n   */\n  addPosts(posts) {\n    // Displays the list of posts\n    const postIds = Object.keys(posts);\n    for (let i = postIds.length - 1; i >= 0; i--) {\n      this.noPostsMessage.hide();\n      const postData = posts[postIds[i]];\n      const post = new friendlyPix.Post();\n      this.posts.push(post);\n      const postElement = post.fillPostData(postIds[i], postData.thumb_url || postData.url,\n          postData.text, postData.author, postData.timestamp, null, null, postData.full_url);\n      // If a post with similar ID is already in the feed we replace it instead of appending.\n      const existingPostElement = $(`.fp-post-${postIds[i]}`, this.feedImageContainer);\n      if (existingPostElement.length) {\n        existingPostElement.replaceWith(postElement);\n      } else {\n        this.feedImageContainer.append(postElement.addClass(`fp-post-${postIds[i]}`));\n      }\n    }\n  }\n\n  /**\n   * Shows the \"load next page\" button and binds it the `nextPage` callback. If `nextPage` is `null`\n   * then the button is hidden.\n   */\n  toggleNextPageButton(nextPage) {\n    this.nextPageButton.unbind('click');\n    if (nextPage) {\n      const loadMorePosts = () => {\n        this.nextPageButton.prop('disabled', true);\n        console.log('Loading next page of posts.');\n        nextPage().then(data => {\n          this.addPosts(data.entries);\n          this.toggleNextPageButton(data.nextPage);\n        });\n      };\n      this.nextPageButton.show();\n      // Enable infinite Scroll.\n      friendlyPix.MaterialUtils.onEndScroll(100).then(loadMorePosts);\n      this.nextPageButton.prop('disabled', false);\n      this.nextPageButton.click(loadMorePosts);\n    } else {\n      this.nextPageButton.hide();\n    }\n  }\n\n  /**\n   * Prepends the list of new posts stored in `this.newPosts`. This happens when the user clicks on\n   * the \"Show new posts\" button.\n   */\n  showNewPosts() {\n    const newPosts = this.newPosts;\n    this.newPosts = {};\n    this.newPostsButton.hide();\n    const postKeys = Object.keys(newPosts);\n\n    for (let i = 0; i < postKeys.length; i++) {\n      this.noPostsMessage.hide();\n      const post = newPosts[postKeys[i]];\n      const postElement = new friendlyPix.Post();\n      this.posts.push(postElement);\n      this.feedImageContainer.prepend(postElement.fillPostData(postKeys[i], post.thumb_url ||\n          post.url, post.text, post.author, post.timestamp, null, null, post.full_url));\n    }\n  }\n\n  /**\n   * Displays the general posts feed.\n   */\n  showGeneralFeed() {\n    // Clear previously displayed posts if any.\n    this.clear();\n\n    // Load initial batch of posts.\n    friendlyPix.firebase.getPosts().then(data => {\n      // Listen for new posts.\n      const latestPostId = Object.keys(data.entries)[Object.keys(data.entries).length - 1];\n      friendlyPix.firebase.subscribeToGeneralFeed(\n          (postId, postValue) => this.addNewPost(postId, postValue), latestPostId);\n\n      // Adds fetched posts and next page button if necessary.\n      this.addPosts(data.entries);\n      this.toggleNextPageButton(data.nextPage);\n    });\n\n    // Listen for posts deletions.\n    friendlyPix.firebase.registerForPostsDeletion(postId => this.onPostDeleted(postId));\n  }\n\n  /**\n   * Shows the feed showing all followed users.\n   */\n  showHomeFeed() {\n    // Clear previously displayed posts if any.\n    this.clear();\n\n    if (this.auth.currentUser) {\n      // Make sure the home feed is updated with followed users's new posts.\n      friendlyPix.firebase.updateHomeFeeds().then(() => {\n        // Load initial batch of posts.\n        friendlyPix.firebase.getHomeFeedPosts().then(data => {\n          const postIds = Object.keys(data.entries);\n          if (postIds.length === 0) {\n            this.noPostsMessage.fadeIn();\n          }\n          // Listen for new posts.\n          const latestPostId = postIds[postIds.length - 1];\n          friendlyPix.firebase.subscribeToHomeFeed(\n              (postId, postValue) => {\n                this.addNewPost(postId, postValue);\n              }, latestPostId);\n\n          // Adds fetched posts and next page button if necessary.\n          this.addPosts(data.entries);\n          this.toggleNextPageButton(data.nextPage);\n        });\n\n        // Add new posts from followers live.\n        friendlyPix.firebase.startHomeFeedLiveUpdaters();\n\n        // Listen for posts deletions.\n        friendlyPix.firebase.registerForPostsDeletion(postId => this.onPostDeleted(postId));\n      });\n    }\n  }\n\n  /**\n   * Triggered when a post has been deleted.\n   */\n  onPostDeleted(postId) {\n    // Potentially remove post from in-memory new post list.\n    if (this.newPosts[postId]) {\n      delete this.newPosts[postId];\n      const nbNewPosts = Object.keys(this.newPosts).length;\n      this.newPostsButton.text(`Display ${nbNewPosts} new posts`);\n      if (nbNewPosts === 0) {\n        this.newPostsButton.hide();\n      }\n    }\n\n    // Potentially delete from the UI.\n    $(`.fp-post-${postId}`, this.pageFeed).remove();\n  }\n\n  /**\n   * Adds a new post to display in the queue.\n   */\n  addNewPost(postId, postValue) {\n    this.newPosts[postId] = postValue;\n    this.newPostsButton.text(`Display ${Object.keys(this.newPosts).length} new posts`);\n    this.newPostsButton.show();\n  }\n\n  /**\n   * Clears the UI.\n   */\n  clear() {\n    // Delete the existing posts if any.\n    $('.fp-post', this.feedImageContainer).remove();\n\n    // Hides the \"next page\" and \"new posts\" buttons.\n    this.nextPageButton.hide();\n    this.newPostsButton.hide();\n\n    // Remove any click listener on the next page button.\n    this.nextPageButton.unbind('click');\n\n    // Stops then infinite scrolling listeners.\n    friendlyPix.MaterialUtils.stopOnEndScrolls();\n\n    // Clears the list of upcoming posts to display.\n    this.newPosts = {};\n\n    // Displays the help message for empty feeds.\n    this.noPostsMessage.hide();\n\n    // Remove Firebase listeners.\n    friendlyPix.firebase.cancelAllSubscriptions();\n\n    // Stops all timers if any.\n    this.posts.forEach(post => post.clear());\n    this.posts = [];\n  }\n};\n\nfriendlyPix.feed = new friendlyPix.Feed();\n"]}